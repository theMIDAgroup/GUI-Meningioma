%% Preprocessing_Files()% LISCOMP Lab 2021- 2022, https://liscomp.dima.unige.it% -------------------------------------------------------------------------% DESCRIPTION:% This function pre-processes the dicom files in the folder defined in% inputpath. It runs only if a "Info.mat" file does not exist yet.% Dicom files are read and information about the acquisition, the slice% location, patients data are stored in "Info.mat".% -------------------------------------------------------------------------%%%% called by: Load_Data()function Preprocessing_Files()global Info;global gui_ROI;FilesList = dir(Info.InputPath);while FilesList(1).name(1) == '.'    FilesList(1) = [];endnumber_of_file = length(FilesList);temp_index   = zeros(number_of_file,5);for it = 1 : number_of_file    INFO = dicominfo([Info.InputPath,gui_ROI.slash_pc_mac, FilesList(it).name]);    if isfield(INFO,'SliceLocation')        temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,INFO.SliceLocation, it, INFO.ImagePositionPatient(3)];    else        temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,0, it, 0];    end    temp_modality{it} = INFO.Modality;endclear INFO;temp_index = sortrows(temp_index);[~,index_cambio_acquisizione_start] = unique(temp_index(:,1),'first');[~,index_cambio_acquisizione_end] = unique(temp_index(:,1),'last');count_CTSeries = 1;count_MRSeries = 1;for t = 1:length(index_cambio_acquisizione_start)    index1 = index_cambio_acquisizione_start(t);    index2 = index_cambio_acquisizione_end(t);    % case 'MR'    Info.FileMR = FilesList(temp_index(index1:index2,4));    Info.LocationMR = temp_index(index1:index2,3);    Info.NumberFileMR = length(Info.FileMR);    Info.SeriesNumberMR = temp_index(index1,1);    INFO1 = dicominfo([Info.InputPath, gui_ROI.slash_pc_mac, Info.FileMR(1).name]);    if index1<index2        Info.SliceThicknessMR = abs(Info.LocationMR(2)-Info.LocationMR(1));        Info.SlopeMR = Info.LocationMR(2)-Info.LocationMR(1);        Info.InterceptMR = Info.LocationMR(1) - Info.SlopeMR;    else        Info.SliceThicknessMR = 0;        Info.SlopeMR = 0;        Info.InterceptMR = 0;    end%     Info.PixelSpacingMR = [];%     if isfield(INFO1,'PixelSpacing'), Info.PixelSpacingMR = INFO1.PixelSpacing; end    Info.SeriesDescriptionMR = [];    if isfield(INFO1,'SeriesDescription'), Info.SeriesDescriptionMR = INFO1.SeriesDescription; end    count_MRSeries = count_MRSeries+1;endInfo.PatientName.FamilyName = [];Info.PatientName.GivenName = [];Info.PatientSex = [];Info.PatientWeight = [];Info.PatientAge = [];Info.AcquisitionDate = [];Info.NumCol = [];Info.NumRow = [];INFO = dicominfo([Info.InputPath, gui_ROI.slash_pc_mac, FilesList(1).name]);if isfield(INFO,'PatientName')    Info.PatientName.FamilyName = INFO.PatientName.FamilyName;    if isfield(INFO.PatientName,'GivenName')        Info.PatientName.GivenName = INFO.PatientName.GivenName;    endendif isfield(INFO,'PatientSex'), Info.PatientSex = INFO.PatientSex; endif isfield(INFO,'PatientWeight'), Info.PatientWeight = num2str(INFO.PatientWeight); endif isfield(INFO,'PatientAge'), Info.PatientAge = num2str(str2double(INFO.PatientAge(:))); endif isfield(INFO,'AcquisitionDate'), Info.AcquisitionDate = INFO.AcquisitionDate; endif isfield(INFO,'Columns'), Info.NumCol = INFO.Columns; endif isfield(INFO,'Rows'), Info.NumRow = INFO.Rows; endif isfield(INFO,'SeriesDescription'), Info.SeriesDescription = INFO.SeriesDescription; endInfo.PatientID = INFO1.PatientID;end